generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Account - a registered user
model Account {
  id        String   @id @default(uuid())
  email     String   @unique
  settings  Json     @default("{}")
  createdAt DateTime @default(now())

  speakers     Speaker[]
  topics       Topic[]
  submissions  Submission[]
  chatSessions ChatSession[]
}

// Speaker - one account may have multiple speakers (family sharing)
model Speaker {
  id                  String   @id @default(uuid())
  accountId           String
  voiceprintEmbedding Float[]  @default([])
  label               String   @default("Default")
  languageProfile     Json     @default("{}")
  createdAt           DateTime @default(now())
  lastActiveAt        DateTime @default(now())

  account         Account          @relation(fields: [accountId], references: [id], onDelete: Cascade)
  submissions     Submission[]
  grammarErrors   GrammarError[]
  vocabularyUsage VocabularyUsage[]
  chatSessions    ChatSession[]
  reviewItems     ReviewItem[]
}

// Topic - a generated learning topic
// Two types: 'translation' (中译英) and 'expression' (话题表达)
model Topic {
  id                 String   @id @default(uuid())
  accountId          String
  type               String   @default("translation") // 'translation' | 'expression'
  originalInput      String   // User's input keywords/topic
  topicContent       Json     // TranslationTopic or ExpressionTopic content
  difficultyMetadata Json?
  createdAt          DateTime @default(now())

  account      Account       @relation(fields: [accountId], references: [id], onDelete: Cascade)
  submissions  Submission[]
  chatSessions ChatSession[]

  @@index([accountId, type])
}

// Submission - each user response
model Submission {
  id                   String   @id @default(uuid())
  topicId              String
  accountId            String
  speakerId            String?
  attemptNumber        Int
  inputMethod          String   // 'voice' | 'text'
  rawAudioUrl          String?
  transcribedText      String
  evaluation           Json     // TranslationEvaluationScores or ExpressionEvaluationScores
  difficultyAssessment Json?
  createdAt            DateTime @default(now())

  topic           Topic            @relation(fields: [topicId], references: [id], onDelete: Cascade)
  account         Account          @relation(fields: [accountId], references: [id], onDelete: Cascade)
  speaker         Speaker?         @relation(fields: [speakerId], references: [id])
  grammarErrors   GrammarError[]
  vocabularyUsage VocabularyUsage[]
}

// GrammarError - track grammar errors for analysis
model GrammarError {
  id            String   @id @default(uuid())
  submissionId  String
  speakerId     String?
  errorPattern  String
  originalText  String?
  correctedText String?
  severity      String?  // 'low' | 'medium' | 'high'
  createdAt     DateTime @default(now())

  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  speaker    Speaker?   @relation(fields: [speakerId], references: [id])
}

// VocabularyUsage - track vocabulary usage
model VocabularyUsage {
  id           String   @id @default(uuid())
  submissionId String
  speakerId    String?
  word         String
  wasFromHint  Boolean  @default(false)
  usedCorrectly Boolean @default(true)
  cefrLevel    String?
  createdAt    DateTime @default(now())

  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  speaker    Speaker?   @relation(fields: [speakerId], references: [id])

  @@index([speakerId, word])
}

// ChatSession - conversation sessions for memory system
model ChatSession {
  id              String    @id @default(uuid())
  accountId       String
  speakerId       String?
  topicId         String?
  sessionType     String    @default("practice")  // 'practice' | 'review'
  status          String    @default("active")    // 'active' | 'ended'
  startedAt       DateTime  @default(now())
  endedAt         DateTime?
  contextSummary  Json?     // Compressed context for long sessions
  messageCount    Int       @default(0)
  extractedData   Json?     // Learning data extracted at session end

  account         Account       @relation(fields: [accountId], references: [id], onDelete: Cascade)
  speaker         Speaker?      @relation(fields: [speakerId], references: [id])
  topic           Topic?        @relation(fields: [topicId], references: [id])
  messages        ChatMessage[]

  @@index([accountId, status])
  @@index([accountId, startedAt])
}

// ChatMessage - individual messages in a chat session
model ChatMessage {
  id              String    @id @default(uuid())
  sessionId       String
  role            String    // 'user' | 'assistant' | 'system'
  content         String
  contentType     String    @default("text")  // 'text' | 'evaluation'
  metadata        Json?
  createdAt       DateTime  @default(now())

  session         ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
}

// ReviewItem - FSRS spaced repetition items (per-concept, not per-submission)
model ReviewItem {
  id            String   @id @default(uuid())
  speakerId     String
  itemType      String   // 'vocabulary' | 'grammar'
  itemKey       String   // word or error pattern
  displayData   Json     // { word, context, cefrLevel } or { pattern, example, correction }
  stability     Float    @default(0)
  difficulty    Float    @default(0)
  elapsedDays   Float    @default(0)
  scheduledDays Float    @default(0)
  reps          Int      @default(0)
  lapses        Int      @default(0)
  state         String   @default("New")  // 'New' | 'Learning' | 'Review' | 'Relearning'
  lastReview    DateTime?
  nextReview    DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  speaker       Speaker  @relation(fields: [speakerId], references: [id], onDelete: Cascade)

  @@unique([speakerId, itemType, itemKey])
  @@index([speakerId, nextReview])
}
